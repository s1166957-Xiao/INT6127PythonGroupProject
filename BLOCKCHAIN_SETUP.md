# 区块链功能运行指南

本文档说明如何配置和运行区块链功能。

## 方式一：使用本地测试网络（Ganache）- 推荐

### 1. 安装 Ganache

Ganache 是一个本地以太坊区块链，用于开发和测试。

**下载地址：**
- Windows: https://trufflesuite.com/ganache/
- 或使用 npm: `npm install -g ganache`

### 2. 启动 Ganache

1. 打开 Ganache 应用程序
2. 点击 "New Workspace" 或 "Quick Start"
3. 记录以下信息：
   - **RPC URL**: 通常是 `http://127.0.0.1:7545` 或 `http://127.0.0.1:8545`
   - **账户私钥**: 在 Ganache 界面中可以看到每个账户的私钥
   - **账户地址**: 用于接收测试币

### 3. 部署智能合约

您需要先部署智能合约到 Ganache 网络。合约地址将用于配置。

**如果没有智能合约，可以使用以下简化方案：**

创建一个简单的测试合约地址（在 Ganache 中创建一个新账户的地址即可作为临时合约地址进行连接测试）。

### 4. 配置区块链

在快递管理系统中：
1. 以管理员身份登录
2. 点击菜单：**区块链 → 配置区块链**
3. 填写信息：
   - **RPC URL**: `http://127.0.0.1:7545` (或 Ganache 显示的端口)
   - **私钥**: Ganache 中显示的账户私钥（去掉 0x 前缀或保留都可以）
   - **合约地址**: 部署的智能合约地址

### 5. 测试上传

配置完成后，可以：
- 点击 **区块链 → 上传所有数据到区块链**
- 或添加快递后自动上传（如果已配置）

---

## 方式二：使用公共测试网（Sepolia）

### 1. 获取测试币

1. 访问 Sepolia 水龙头获取测试 ETH：
   - https://sepoliafaucet.com/
   - https://faucet.quicknode.com/ethereum/sepolia

2. 使用 MetaMask 或其他钱包创建账户并获取私钥

### 2. 获取 RPC URL

使用公共 RPC 节点：
- Infura: https://sepolia.infura.io/v3/YOUR_PROJECT_ID
- Alchemy: https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY
- 公共节点: https://rpc.sepolia.org

### 3. 部署合约

将智能合约部署到 Sepolia 测试网，获取合约地址。

### 4. 配置和使用

同方式一的步骤 4-5。

---

## 方式三：仅测试数据导出（不连接区块链）

如果您只想测试数据导出功能，不需要真实的区块链连接：

1. 运行测试脚本：
   ```bash
   python test_blockchain.py
   ```
   选择选项 3，将创建测试数据文件。

2. 在快递管理系统中：
   - 添加一些快递和用户数据
   - 使用菜单：**区块链 → 上传所有数据到区块链**
   - 系统会先导出数据到 Excel，然后尝试上传（如果未配置区块链会提示）

---

## 测试脚本使用

运行测试脚本可以快速验证区块链功能：

```bash
python test_blockchain.py
```

脚本会：
1. 创建测试数据（快递和用户）
2. 测试区块链连接
3. 测试数据上传
4. 显示上链统计

---

## 常见问题

### 1. 连接失败：无法连接到区块链节点

**解决方案：**
- 检查 RPC URL 是否正确
- 确认 Ganache 或测试网节点正在运行
- 检查网络连接

### 2. 交易失败：insufficient funds

**解决方案：**
- 确保账户有足够的 ETH（测试币）
- 在 Ganache 中，账户默认有 100 ETH
- 在测试网中，需要从水龙头获取测试币

### 3. 合约调用失败

**解决方案：**
- 确认合约地址正确
- 确认合约已正确部署
- 检查合约 ABI 是否匹配

### 4. 私钥格式错误

**解决方案：**
- 私钥可以带或不带 `0x` 前缀
- 确保私钥是 64 个十六进制字符（32 字节）

---

## 快速开始（最小配置）

如果您只是想快速看到区块链功能运行，可以使用以下最小配置：

1. **安装 Ganache**（最简单的方式）
2. **启动 Ganache**，使用默认设置
3. **在快递管理系统中配置**：
   - RPC URL: `http://127.0.0.1:7545`
   - 私钥: Ganache 界面中显示的任意账户私钥
   - 合约地址: 可以使用 Ganache 中显示的任意账户地址作为临时测试（实际部署需要真实合约）

**注意：** 如果没有部署真实的智能合约，上传操作会失败，但您可以看到：
- 区块链连接是否成功
- 数据导出功能是否正常
- 错误提示信息

---

## 查看运行结果

### 在控制台查看

运行快递管理系统时，区块链操作的日志会输出到控制台，包括：
- ✓ 连接成功信息
- ✓ 交易哈希
- ✓ 上链记录ID
- ✗ 错误信息

### 在界面查看

1. **上链统计**：菜单 → 区块链 → 查看上链统计
2. **上传结果**：上传操作完成后会弹出提示框显示结果

### 在区块链浏览器查看

- **Ganache**: 在 Ganache 界面中查看交易
- **Sepolia**: 在 https://sepolia.etherscan.io/ 输入交易哈希查看

---

## 下一步

配置完成后，您可以：
1. 在系统中添加快递数据
2. 系统会自动在后台上传数据到区块链（如果已配置）
3. 或手动通过菜单上传数据
4. 查看上链统计和记录

